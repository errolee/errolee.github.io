<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After School Tuition</title>
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    <script src="lessons.js"></script>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div id="lessons"> 
        <header>
            <h1>{{ webtitle }}</h1>
            <button id="ViewCart" v-on:click="toggleView" :disabled="cart.length === 0" class="button-class" aria-label="View shopping cart">
                <span class="fas fa-cart-plus"></span> {{ itemsInTheCart }} Shopping Cart
            </button>
        </header>

        <p>
            <strong>Search Lessons:</strong>
            <input v-model="searchQuery" placeholder="Type to search..." />
        </p>

        <!-- Sorting Section -->
        <div v-if="showlesson" class="sorting-card">
            <h3>Sort by:</h3>
            <label>
                <input type="radio" v-model="sortKey" value="subject" @change="sortLessons"> Subject
            </label>
            <label>
                <input type="radio" v-model="sortKey" value="location" @change="sortLessons"> Location
            </label>
            <label>
                <input type="radio" v-model="sortKey" value="price" @change="sortLessons"> Price
            </label>
            <label>
                <input type="radio" v-model="sortKey" value="availability" @change="sortLessons"> Availability
            </label>

            <h3>Order:</h3>
            <label>
                <input type="radio" v-model="sortOrder" value="asc" @change="sortLessons"> Ascending
            </label>
            <label>
                <input type="radio" v-model="sortOrder" value="desc" @change="sortLessons"> Descending
            </label>
        </div>

        <main>
            <!-- Lessons Section -->
            <div v-if="showlesson" class="lessons-container">
                <div v-for="lesson in filteredLessons" :key="lesson.subject" class="lesson-card">
                    <!-- <img v-if="lesson.image" :src="'static-images/' + lesson.icon" :alt="lesson.subject + ' Image'" class="lesson-image" /> -->
                   <i :class="lesson.icon" class="lesson-icon"></i>
                    <h2 v-text="lesson.subject"></h2>
                    <p v-text="lesson.location"></p>
                    <p>Price: ${{ lesson.price }}</p>
                    <p>Availability: {{ lesson.availability }}</p>

                    <button v-if="canAddToCart(lesson)"
                    :disabled="lesson.availability <= 0" 
                    v-on:click="addItemToCart(lesson)">
                    Add to Cart
                </button>
                
                    <div v-else>
                        <button disabled>Add to Cart</button>
                        You have added all available items for this product to your cart.
                    </div>
                </div>
            </div>

            <!-- Cart Section -->
            <div v-else>
                    <h1>Checkout</h1>
                    <div class="cartSummary">
                        <h2>Cart Summary</h2>
                        <ul>
                            <!-- Loop through cart items and display details -->
                            <li v-for="lesson in cart" :key="lesson.id">
                                <div class="lesson-card">
                                    <p><strong>{{ lesson.subject }}</strong></p>
                                    <p>Price: ${{ lesson.price }}</p>
                                    <p v-if="lesson.availability > 1">Spaces: {{ lesson.availability }}</p>
                                    <button @click="removeItemFromCart(lesson)">Remove</button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <form>
                        <p><strong>Name:</strong> <input v-model.trim="order.name" /></p>
                        <p><strong>Phone:</strong> <input v-model.trim="order.phone" type="tel" /></p>
                    </form>
                    <div class="detail">
                        <div class="details">
                            <h1>Your Details</h1>
                            <p>Name: <strong>{{ order.name }}</strong></p>
                            <p>Phone: <strong>{{ order.phone }}</strong></p>
                        </div>                        
                        <button @click="checkout" :disabled="!isCheckoutEnabled">Checkout</button>
                        <p v-if="confirmationMessage">{{ confirmationMessage }}</p>
                    </div>
                </div>
            </div>
            
        </main>
    </div>

    <script>
        new Vue({
            el: '#lessons',
            data: {
                webtitle: 'After School Tuition App',
                showlesson: true,
                lessons: [], // Default empty array, to be populated via fetch
                cart: [],
                order: {
                    name: "",
                    phone: "",
                },
                sortKey: 'subject',
                sortOrder: 'asc',
                searchQuery: '',
                nameError: false,
                phoneError: false,
                confirmationMessage: '',
            },
            methods: {
                fetchProducts() {
                    fetch('https://fullstack-backend-s1kh.onrender.com/lessons')
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to fetch lessons');
                            return response.json();
                        })
                        .then(data => {
                            this.lessons = data;
                        })
                        .catch(error => {
                            console.error(error);
                            alert('Could not load lessons. Please try again later.');
                        });
                },
                toggleView() {
                    this.showlesson = !this.showlesson;
                },
                addItemToCart(lesson) {
                    if (lesson.availability > 0) {
                        this.cart.push(lesson);
                        this.$set(lesson, 'availability', lesson.availability - 1);
                    }
                },
                removeItemFromCart(lesson) {
                    const index = this.cart.findIndex(item => item.id === lesson.id);
                    if (index !== -1) {
                        this.cart.splice(index, 1);
                        this.$set(lesson, 'availability', lesson.availability + 1);
                        console.log("Cart after removing item:", this.cart);
                    }
                    if (this.cart.length === 0) {
                        this.showlesson = true;
                    }
                },
                canAddToCart(lesson) {
                    return lesson.availability > 0;
                },
                validateName() {
                    const nameRegex = /^[A-Za-z\s]+$/;
                    this.nameError = !nameRegex.test(this.order.name);
                },
                validatePhone() {
                    const phoneRegex = /^[0-9]+$/;
                    this.phoneError = !phoneRegex.test(this.order.phone);
                },
                checkout() {
                    if (!this.nameError && !this.phoneError) {
                        const orderData = {
                            name: this.order.name,
                            phone: this.order.phone,
                            lessons: this.cart.map(lesson => ({
                                lessonID: lesson._id,  // Use MongoDB's `_id` as lessonID
                                availability: lesson.availability || 1  // Default to 1 if not specified
                            })),
                            totalPrice: this.cart.reduce(
                                (sum, lesson) => sum + lesson.price * (lesson.availability || 1), 0
                            ),
                        };

                        // Update lesson availability on the server
                        Promise.all(
                            this.cart.map(lesson => {
                                return fetch(`https://fullstack-backend-s1kh.onrender.com/${lesson._id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ availability: lesson.availability - (lesson.availability || 1)}) //add the lessons.spaces
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Lesson updated:', data);
                                    })
                                    .catch(error => {
                                        console.error('Error updating lesson availability:', error);
                                    });
                            })
                        )
                            .then(() => {
                                // Submit the order only after availability is updated
                                return fetch('https://fullstack-backend-s1kh.onrender.com/order', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(orderData),
                                });
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.insertedId) {
                                    alert("Your order has been placed successfully!");
                                    this.cart = [];  // Clear the cart
                                    this.order = { name: "", phone: "" };  // Reset order form
                                    this.showlesson = true; // show lesson true
                                } else {
                                    alert("Failed to submit order.");
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                this.confirmationMessage = "An error occurred.";
                            });
                    } else {
                        this.confirmationMessage = "Please fix errors before submitting.";
                    }
                },
                sortLessons() {
                    this.lessons = [...this.lessons].sort((a, b) => {
                        let result = a[this.sortKey] > b[this.sortKey] ? 1 : -1;
                        return this.sortOrder === 'asc' ? result : -result;
                    });
                },
            },
            computed: {
                itemsInTheCart() {
                    return this.cart.length;
                },
                isCheckoutEnabled() {
                    return !this.nameError && !this.phoneError && this.order.name && this.order.phone;
                },
                filteredLessons() {
                    if (!Array.isArray(this.lessons)) return [];
                    return this.lessons.filter(lesson =>
                        lesson.subject.toLowerCase().includes(this.searchQuery.toLowerCase())
                    );
                },
                totalPrice() {
                    return this.cart.reduce((sum, lesson) => sum + lesson.price, 0); //display totalprice
                },
            },
            mounted() {
                this.fetchProducts();
                console.log("Cart data:", this.cart);
            }
        });
    </script>
</body>
</html>
