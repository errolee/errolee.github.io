<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After School Tuition</title>
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    <script src="lessons.js"></script>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <div id="lessons"> 
        <header>
            <h1>{{ webtitle }}</h1>
            <button id="ViewCart" v-on:click="toggleView" :disabled="cart.length === 0" class="button-class" aria-label="View shopping cart">
                <span class="fas fa-cart-plus"></span> {{ itemsInTheCart }} Shopping Cart
            </button>
        </header>

        <p>
            <strong>Search Lessons:</strong>
            <input v-model="searchQuery" placeholder="Type to search..." />
        </p>

        <!-- Sorting Section -->
        <div v-if="showlesson" class="sorting-card">
            <h3>Sort by:</h3>
            <label>
                <input type="radio" v-model="sortKey" value="subject" @change="sortLessons"> Subject
            </label>
            <label>
                <input type="radio" v-model="sortKey" value="location" @change="sortLessons"> Location
            </label>
            <label>
                <input type="radio" v-model="sortKey" value="price" @change="sortLessons"> Price
            </label>
            <label>
                <input type="radio" v-model="sortKey" value="availability" @change="sortLessons"> Availability
            </label>

            <h3>Order:</h3>
            <label>
                <input type="radio" v-model="sortOrder" value="asc" @change="sortLessons"> Ascending
            </label>
            <label>
                <input type="radio" v-model="sortOrder" value="desc" @change="sortLessons"> Descending
            </label>
        </div>

        <main>
            <!-- Lessons Section -->
            <div v-if="showlesson" class="lessons-container">
                <div v-for="lesson in filteredLessons" :key="lesson.id" class="lesson-card">
                    <!-- <img v-if="lesson.image" :src="'static-images/' + lesson.icon" :alt="lesson.subject + ' Image'" class="lesson-image" /> -->
                    <i :class="lesson.icon" class="lesson-icon"></i>
                    <h2 v-text="lesson.subject"></h2>
                    <p v-text="lesson.location"></p>
                    <p>Price: ${{ lesson.price }}</p>
                    <p>Availability: {{ lesson.availability }}</p>

                    <button v-if="canAddToCart(lesson)" :disabled="cart.includes(lesson)" v-on:click="addItemToCart(lesson)">Add to Cart</button>
                    <div v-else>
                        <button disabled>Add to Cart</button>
                        You have added all available items for this product to your cart.
                    </div>
                </div>
            </div>

            <!-- Cart Section -->
            <div v-else>
                <h1>Your Cart</h1> 
                <div class="lessons-container">
                    <div v-for="lesson in cart" :key="lesson.id" class="lesson-card">
                        <h2 v-text="lesson.subject"></h2>
                        <p v-text="lesson.location"></p>
                        <p>Price: ${{ lesson.price }}</p>
                        <button v-on:click="removeItemFromCart(lesson)">Remove from Cart</button>
                    </div>
                </div>
                <div>
                    <h1>Checkout</h1>
                    <p>
                        <strong>Name:</strong>
                        <input v-model="order.name" @input="validateName" />
                    </p>
                    <p v-if="nameError" style="color: red;">Please enter a valid name (letters and spaces only).</p>

                    <p>
                        <strong>Phone:</strong>
                        <input type="tel" v-model="order.phone" @input="validatePhone" />
                    </p>
                    <p v-if="phoneError" style="color: red;">Please enter a valid phone number (numbers only).</p>

                    <button @click="checkout" :disabled="!isCheckoutEnabled">Checkout</button>
                    <p v-if="confirmationMessage">{{ confirmationMessage }}</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        new Vue({
            el: '#lessons',
            data: {
                webtitle: 'After School Tuition App',
                showlesson: true,
                lessons: [], // Default empty array, to be populated via fetch
                cart: [],
                order: {
                    name: "",
                    phone: "",
                },
                sortKey: 'subject',
                sortOrder: 'asc',
                searchQuery: '',
                nameError: false,
                phoneError: false,
                confirmationMessage: '',
            },
            methods: {
                fetchProducts() {
                    fetch('http://localhost:3000/lessons')
                        .then(response => {
                            if (!response.ok) throw new Error('Failed to fetch lessons');
                            return response.json();
                        })
                        .then(data => {
                            this.lessons = data;
                        })
                        .catch(error => {
                            console.error(error);
                            alert('Could not load lessons. Please try again later.');
                        });
                },
                toggleView() {
                    this.showlesson = !this.showlesson;
                },
                addItemToCart(lesson) {
                    if (lesson.availability > 0 && !this.cart.includes(lesson)) {
                        this.cart.push(lesson);
                        lesson.availability--;
                    }
                },
                removeItemFromCart(lesson) {
                    const index = this.cart.findIndex(item => item.id === lesson.id);
                    if (index !== -1) {
                        this.cart.splice(index, 1);
                        lesson.availability++;
                    }
                },
                canAddToCart(lesson) {
                    return lesson.availability > 0;
                },
                validateName() {
                    const nameRegex = /^[A-Za-z\s]+$/;
                    this.nameError = !nameRegex.test(this.order.name);
                },
                validatePhone() {
                    const phoneRegex = /^[0-9]+$/;
                    this.phoneError = !phoneRegex.test(this.order.phone);
                },
                checkout() {
                    if (!this.nameError && !this.phoneError) {
                        this.confirmationMessage = "Order has been submitted successfully!";
                        this.cart = [];
                        this.order = { name: "", phone: "" };
                    } else {
                        this.confirmationMessage = "Please enter valid name and phone number.";
                    }
                },
                sortLessons() {
                    this.lessons = [...this.lessons].sort((a, b) => {
                        let result = a[this.sortKey] > b[this.sortKey] ? 1 : -1;
                        return this.sortOrder === 'asc' ? result : -result;
                    });
                },
            },
            computed: {
                itemsInTheCart() {
                    return this.cart.length;
                },
                isCheckoutEnabled() {
                    return !this.nameError && !this.phoneError && this.order.name && this.order.phone;
                },
                filteredLessons() {
                    if (!Array.isArray(this.lessons)) return [];
                    return this.lessons.filter(lesson =>
                        lesson.subject.toLowerCase().includes(this.searchQuery.toLowerCase())
                    );
                }
            },
            mounted() {
                this.fetchProducts();
            }
        });
    </script>
</body>
</html>
